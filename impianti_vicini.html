<!doctype html>
<html lang="it" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Carburante">

  <title>Impianti vicini ‚Ä¢ Carburante</title>

  <!-- NO CACHE -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- THEME BEFORE PAINT -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia &&
            window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute(
          "data-theme",
          saved || (prefersDark ? "dark" : "light")
        );
      }catch(e){}
    })();
  </script>

  <style>
    :root{
      --space:14px;
      --bg:#ffffff;
      --text:#111827;
      --muted:#666666;
      --surface:#ffffff;
      --border:#dddddd;
      --btn-hover:#f7f7f7;
    }
    html[data-theme="dark"]{
      --bg:#0f1115;
      --text:#e5e7eb;
      --muted:#9aa0a6;
      --surface:#151922;
      --border:#2a2f3a;
      --btn-hover:#1b2130;
    }

    body{ color-scheme:light dark; }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      padding:var(--space);
      min-height:100dvh;
      display:flex;
      flex-direction:column;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .container{
      width:100%;
      max-width:640px;
      margin:0 auto;
    }

    /* HEADER */
    .topbar{
      text-align:center;
      margin-bottom:20px;
    }
    .title{
      margin:0;
      font-size:24px;
      font-weight:700;
    }
    .coords{
      font-size:13px;
      margin-top:4px;
      color:var(--muted);
    }

    /* CARDS */
    .card-block{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      margin-top:10px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .card-gestore{
      font-size:15px;
      font-weight:600;
    }
    .badge-self{
      font-size:11px;
      padding:2px 6px;
      border-radius:99px;
      border:1px solid var(--border);
    }
    .card-indirizzo{
      font-size:13px;
      margin-bottom:4px;
    }
    .card-prezzo{
      font-size:20px;
      font-weight:700;
    }
    .card-meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    #status{
      margin-top:10px;
      text-align:center;
      font-size:13px;
      color:var(--muted);
    }

    .actions-footer{
      margin-top:auto;
      text-align:center;
      padding-top:15px;
    }

    .btn{
      padding:10px 14px;
      display:inline-block;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      text-decoration:none;
      color:inherit;
    }
    .btn:hover{ background:var(--btn-hover); }

    .version-footer{
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }
    .badge{
      padding:2px 6px;
      border:1px solid var(--border);
      border-radius:99px;
      margin-left:6px;
    }

  </style>
</head>
<body>

  <header class="topbar container">
    <h1 class="title">‚õΩÔ∏è Impianti vicini</h1>
    <div class="coords">
      Latitudine: <span id="lat">‚Äî</span> ‚Ä¢ Longitudine: <span id="lon">‚Äî</span>
    </div>
  </header>

  <main class="container">
    <div id="status">In attesa della posizione GPS‚Ä¶</div>
    <div id="results"></div>
  </main>

  <div class="actions-footer">
    <a href="index.html" class="btn">‚Üê Indietro</a>
  </div>

  <div class="version-footer">
    Versione:<span id="appVersion" class="badge"></span>
  </div>

<script>
/* VERSIONE */
function formatVersionFromDate(d){
  const p = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}.${p(d.getMonth()+1)}.${p(d.getDate())}-${p(d.getHours())}:${p(d.getMinutes())}`;
}
document.getElementById("appVersion").textContent =
  formatVersionFromDate(new Date(document.lastModified));

function formatCoord(n){ return Number(n).toFixed(6); }
function formatPrezzo(n){ return Number(n).toFixed(3).replace(".", ","); }

/* ===============================
   CHIAMATA DIRETTA ALL'API
   =============================== */
async function loadImpianti(lat, lon){
  const status  = document.getElementById("status");
  const results = document.getElementById("results");

  status.textContent = "‚è≥ Cerco gli impianti vicini‚Ä¶";

  const params = new URLSearchParams({
    latitude: lat,
    longitude: lon,
    distance: 3,
    fuel: "gasolio",
    results: 100
  });

  const url = `https://prezzi-carburante.onrender.com/api/distributori?${params.toString()}`;

  try{
    const res = await fetch(url);
    const data = await res.json();

    if (!Array.isArray(data)){
      status.textContent = "‚ùå Risposta inattesa dall'API carburanti.";
      return;
    }

    if (data.length === 0){
      status.textContent = "Nessun impianto trovato nel raggio di 3 km.";
      return;
    }

    status.textContent = `Trovati ${data.length} impianti nel raggio di 3 km.`;

    results.innerHTML = "";

    data.forEach((imp, index) => {
      const card = document.createElement("section");
      card.className = "card-block";

      card.innerHTML = `
        <div class="card-header">
          <div class="card-gestore">#${index+1} ¬∑ ${imp.gestore}</div>
          ${imp.self ? '<div class="badge-self">Self</div>' : ""}
        </div>

        <div class="card-indirizzo">${imp.indirizzo}</div>

        <div class="card-prezzo">‚Ç¨ ${formatPrezzo(imp.prezzo)}</div>

        <div class="card-meta">
          <span>${imp.distanza} km</span>
          <span>${imp.data}</span>
          <span>${formatCoord(imp.latitudine)}, ${formatCoord(imp.longitudine)}</span>
        </div>
      `;

      results.appendChild(card);
    });

  }catch(err){
    console.error(err);
    status.textContent = "‚ùå Errore di connessione all'API carburanti.";
  }
}

/* GEOLOCALIZZAZIONE */
function initGeolocation(){
  const status = document.getElementById("status");
  const latEl = document.getElementById("lat");
  const lonEl = document.getElementById("lon");

  status.textContent = "üì° Attendo il fix del GPS‚Ä¶";

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      latEl.textContent = formatCoord(lat);
      lonEl.textContent = formatCoord(lon);

      loadImpianti(lat, lon);
    },
    err => {
      status.textContent = "‚ùå Errore nella geolocalizzazione.";
    },
    { enableHighAccuracy:true, timeout:15000 }
  );
}

document.addEventListener("DOMContentLoaded", initGeolocation);
</script>

</body>
</html>

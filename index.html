<!doctype html>
<html lang="it" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Carburante</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Carburante">

  <!-- No-cache per ridurre ambiguit√† tra versioni su GitHub Pages -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Imposta il tema PRIMA del paint, come in Pellet -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      }catch(e){}
    })();
  </script>

  <style>
    :root{
      --space:14px;

      /* Tema chiaro identico a Pellet */
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --surface:#ffffff;
      --border:#e5e7eb;
      --divider:#e5e7eb;
      --btn-hover:#f9fafb;
      --primary:#1f2937;
      --shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.03);

      --radius:12px;
    }
    html[data-theme="dark"]{
      --bg:#0f1115;
      --text:#e5e7eb;
      --muted:#9aa0a6;
      --surface:#151922;
      --border:#2a2f3a;
      --divider:#222834;
      --btn-hover:#1b2130;
      --primary:#e5e7eb;
      --shadow:0 1px 3px rgba(0,0,0,.4),0 1px 2px rgba(0,0,0,.3);
    }
    *{ box-sizing:border-box; }
    html,body{ width:100%; max-width:100%; margin:0; overflow-x:hidden; }
    body{
      min-height:100dvh;
      padding: var(--space);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      color-scheme: light dark;
    }

    /* Contenitore centrato (come Pellet) */
    .container{ width:100%; max-width:1200px; margin:0 auto; }

    /* Topbar con titolo centrato e hamburger sinistra (come Pellet) */
    .topbar{
      display:grid;
      grid-template-columns:48px 1fr 48px; /* [hamburger][titolo][spazio] */
      align-items:center;
      height:48px;
      margin-bottom:10px;
    }
    .title{
      grid-column:2;
      margin:0;
      text-align:center;
      font-size:22px;
      font-weight:700;
    }
    .menu-btn{
      justify-self:start;
      background:#fff0;
      border:none;
      font-size:22px;
      line-height:1;
      padding:8px 12px;
      cursor:pointer;
      border-radius:999px;
      box-shadow: var(--shadow);
      background: var(--surface);
    }

    /* Pulsante hamburger flottante in basso a sinistra (come Pellet) */
    .fab{
      position: fixed; left: var(--space); bottom: calc(var(--space) + env(safe-area-inset-bottom));
      width:40px; height:40px; border-radius:999px; display:flex; align-items:center; justify-content:center;
      background: var(--surface); box-shadow: var(--shadow); border:1px solid var(--border);
      cursor:pointer; z-index: 9996;
    }

    /* Drawer identico a Pellet */
    .drawer{
      position:fixed; inset:0 35% 0 0;
      max-width:280px;
      background: var(--surface);
      border-right:1px solid var(--border);
      transform:translateX(-105%);
      transition:transform .2s ease;
      z-index:9998;
      padding:16px;
    }
    .drawer h3{ margin:6px 0 14px; }
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.15);
      display:none;
      z-index:9997;
    }
    .tile{
      display:flex; align-items:center; gap:10px;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      box-shadow: var(--shadow);
      text-decoration:none; color:inherit;
    }
    .tile + .tile{ margin-top:12px; }
    .muted{ color: var(--muted); font-size:12px; }
    .divider{ height:1px; background: var(--divider); margin:12px 0; }

    label{ display:block; margin: 12px 0 6px; font-size:14px; }
    input, select, textarea, button{
      width:100%;
      font-size:16px;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background: var(--surface);
      color: var(--text);
    }
    input::placeholder, textarea::placeholder{ color: #9aa0a6; }
    button{
      margin-top:16px; display:inline-flex; align-items:center; justify-content:center; gap:8px;
      cursor:pointer;
    }
    button:hover{ background: var(--btn-hover); }
    button[disabled]{ opacity:.7; cursor:not-allowed; }

    .badge{
      display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px;
      border:1px solid var(--border); margin-left:8px; font-variant-numeric: tabular-nums;
      background: var(--surface);
    }

    /* Loader overlay */
    .loading-overlay{
      position:fixed; inset:0; background: rgba(0,0,0,.12);
      display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter: blur(1px);
    }
    .loading-overlay[aria-hidden="false"]{ display:flex; }
    .spinner{
      width:38px; height:38px; border:3px solid rgba(0,0,0,0.2);
      border-top-color: rgba(0,0,0,0.7); border-radius:50%;
      animation: spin 0.9s linear infinite;
      background: var(--surface);
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .btn-spinner{
      width:16px; height:16px; border:2px solid rgba(0,0,0,0.2);
      border-top-color: rgba(0,0,0,0.7); border-radius:50%;
      animation: spin 0.8s linear infinite;
    }

    /* Versione centrata in basso, come Pellet */
    .version-footer{
      text-align:center;
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
      width:100%;
      color: var(--muted);
    }

    /* iframe overlay full screen */
    #pageFrame{
      position:fixed; inset:0; width:100vw; height:100vh; border:0;
      display:none; background:#fff; z-index:9999;
    }
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <header class="topbar container">
    <button id="menuBtn" class="menu-btn" aria-label="Apri menu">‚ò∞</button>
    <h1 class="title">‚õΩÔ∏è Carburante</h1>
    <span aria-hidden="true"></span>
  </header>

  <!-- FORM -->
  <main class="container" role="main">
    <label>Data</label>
    <input id="data" type="date" required>

    <label>Importo (‚Ç¨)</label>
    <select id="importo" required>
      <option value="">Seleziona importo</option>
    </select>

    <label>Prezzo al litro (‚Ç¨)</label>
    <input id="prezzo" type="text" inputmode="numeric" placeholder="es. 1,619" required>

    <label>Litri</label>
    <input id="litri" type="text" inputmode="numeric" placeholder="es. 25,75" required>

    <label>Stazione</label>
    <select id="stazione" required>
      <option value="">Seleziona stazione</option>
    </select>

    <label>Km</label>
    <input id="km" type="number" inputmode="numeric" placeholder="opzionale">

    <button id="saveBtn"><span class="btn-text">Salva</span></button>
    <div id="msg" role="status" aria-live="polite"></div>

    <!-- Versione -->
    <div class="version-footer">Versione: <span id="appVersion" class="badge"></span></div>
  </main>

  <!-- Drawer identico a Pellet -->
  <nav id="drawer" class="drawer" aria-hidden="true">
    <h3>Menu</h3>
    <a id="goLista" class="tile" href="lista.html">üìÑ Lista movimenti</a>

    <div class="divider"></div>

    <!-- Toggle tema identico a Pellet -->
    <button id="themeToggle" class="tile" type="button" aria-label="Tema scuro / chiaro">üåô Tema scuro</button>
  </nav>
  <div id="backdrop" class="backdrop" aria-hidden="true"></div>

  <!-- FAB hamburger in basso a sinistra -->
  <button id="fabMenu" class="fab" aria-label="Apri menu">‚ò∞</button>

  <!-- Overlay full-screen per lista.html -->
  <iframe id="pageFrame"></iframe>

  <!-- Loader -->
  <div id="loaderOverlay" class="loading-overlay" aria-hidden="true" aria-live="polite" aria-busy="false">
    <div class="spinner" role="progressbar" aria-label="Salvataggio in corso"></div>
  </div>

<script>
/* ====== CONFIG back-end ====== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwFKEfcSLjdXSodQtDiIyhHPXskdLdOZ9PXTc0Dt5dlXIFxu8hhb80UwrSJpWqmzv-w/exec';
const SECRET   = 'aX4P-92kLq-55T8b-7Hc0Z';

/* ====== VERSIONE (come Pellet) ====== */
function pad(n){ return String(n).padStart(2,'0'); }
function formatVersionFromDate(d){ return `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}-${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function computeAppVersion(){
  const qs = new URLSearchParams(location.search);
  const v = qs.get('v');
  if (v) return v;
  const d = new Date(document.lastModified);
  return isNaN(d)?'dev':formatVersionFromDate(d);
}
function showAppVersion(){
  const el = document.getElementById('appVersion');
  if (el) el.textContent = computeAppVersion();
}

/* ====== Drawer identico a Pellet ====== */
(function(){
  const btnTop = document.getElementById('menuBtn');
  const btnFab = document.getElementById('fabMenu');
  const drawer = document.getElementById('drawer');
  const backdrop = document.getElementById('backdrop');

  const open = () => { drawer.style.transform='translateX(0)'; backdrop.style.display='block'; drawer.setAttribute('aria-hidden','false'); };
  const close= () => { drawer.style.transform='translateX(-105%)'; backdrop.style.display='none'; drawer.setAttribute('aria-hidden','true'); };

  btnTop.addEventListener('click', open);
  btnFab.addEventListener('click', open);
  backdrop.addEventListener('click', close);

  // Toggle tema (stesso comportamento di Pellet)
  const toggleBtn = document.getElementById('themeToggle');
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
    // avvisa eventuale iframe aperto
    try{ document.getElementById('pageFrame').contentWindow?.postMessage(`theme:${t}`, '*'); }catch{}
    toggleBtn.textContent = (t === 'dark') ? 'üåû Tema chiaro' : 'üåô Tema scuro';
  }
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  applyTheme(current);
  toggleBtn.addEventListener('click', () => {
    const next = (document.documentElement.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
    applyTheme(next);
  });
})();

/* ====== NAV full-screen lista.html (come Pellet) ====== */
(function(){
  const d = new Date(document.lastModified);
  const vIndex = isNaN(d) ? 'dev' : `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}-${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const urlLista = `lista.html?v=${encodeURIComponent(vIndex)}`;

  const linkLista = document.getElementById('goLista');
  const frame     = document.getElementById('pageFrame');
  const drawer    = document.getElementById('drawer');
  const backdrop  = document.getElementById('backdrop');

  function openFrame(url){
    // chiudi drawer e apri overlay
    drawer.style.transform = 'translateX(-105%)';
    backdrop.style.display = 'none';
    drawer.setAttribute('aria-hidden','true');

    frame.src = url;
    frame.style.display = 'block';
    history.pushState({page:'lista'}, '', '#lista'); // back chiude overlay
  }
  function closeFrame(){
    frame.style.display = 'none';
    frame.src = 'about:blank';
    if (location.hash === '#lista') history.back();
  }

  if (linkLista){
    linkLista.href = urlLista; // fallback se aperto fuori PWA
    linkLista.setAttribute('target','_self');
    linkLista.addEventListener('click', (e) => {
      e.preventDefault();
      openFrame(urlLista);
    });
  }

  window.addEventListener('popstate', () => {
    if (frame.style.display === 'block') {
      frame.style.display = 'none';
      frame.src = 'about:blank';
    }
  });

  // chiusura richiesta da lista.html
  window.addEventListener('message', (ev) => {
    if (ev && ev.data === 'close-lista') closeFrame();
  });
})();

/* ====== Helpers ‚Äústile POS‚Äù ======
   - attachPosMoney(el, decimals): mostra virgola live mentre digiti.
   - es. 1619 -> "16,19" con decimals=2 ; 1619 -> "1,619" con decimals=3
*/
function formatPosFromDigits(digits, decimals){
  if (!digits) return '';
  digits = digits.replace(/^0+/, '') || '0';
  if (decimals === 0) return digits;
  if (digits.length <= decimals) return `0,${digits.padStart(decimals, '0')}`;
  const intPart = digits.slice(0, -decimals);
  const decPart = digits.slice(-decimals);
  return `${intPart},${decPart}`;
}
function normalizedFromDigits(digits, decimals){
  if (!/^\d+$/.test(digits)) return null;
  const n = Number(digits) / Math.pow(10, decimals);
  return n.toFixed(decimals); // con punto
}
function parseMoneySmart(value, maxDec=2){
  const raw = String(value||'').trim();
  if (raw === '') return null;
  if (/^\d+$/.test(raw)) return normalizedFromDigits(raw, maxDec);
  const s = raw.replace(',', '.');
  if (!new RegExp(`^\\d+(\\.\\d{1,${maxDec}})?$`).test(s)) return null;
  return Number(s).toFixed(maxDec);
}
function attachPosMoney(el, decimals){
  el.addEventListener('input', () => {
    const digits = (el.value || '').replace(/\D/g, '');
    const display = formatPosFromDigits(digits, decimals);
    const active = document.activeElement === el;
    el.value = display;
    if (active){
      try{ el.setSelectionRange(el.value.length, el.value.length); }catch{}
    }
  });
}

/* ====== POPOLA IMPORTO ====== */
function initImportoOptions(){
  const select = document.getElementById('importo');
  for (let i=5; i<=100; i+=5){
    const v = i.toFixed(2).replace('.', ',');
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    select.appendChild(opt);
  }
}

/* ====== DATA DEFAULT ====== */
function initDate(){
  const d = new Date();
  document.getElementById('data').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

/* ====== STAZIONI ====== */
async function initStations(){
  const sel = document.getElementById('stazione');
  sel.length = 1;
  try{
    const res = await fetch(`${ENDPOINT}?action=stazioni&secret=${encodeURIComponent(SECRET)}`);
    const data = await res.json();
    if (data && data.ok && Array.isArray(data.stations)){
      data.stations.forEach(st => {
        const opt = document.createElement('option');
        opt.value = st.label;
        opt.textContent = st.label;
        opt.dataset.id = st.id;
        sel.appendChild(opt);
      });
      return;
    }
    addFallbackStations(sel);
  }catch{
    addFallbackStations(sel);
  }
}
function addFallbackStations(sel){
  const fallback = [
    { id:'ALTRO', label:'Q8 - ALTRO' },
    { id:'ARDEATINA_558_ROMA', label:'Q8 - VIA ARDEATINA 558 ROMA' },
    { id:'LANUVIO', label:'Q8 - LANUVIO' },
    { id:'VELLETRI', label:'Q8 - VELLETRI' }
  ];
  fallback.forEach(st => {
    const opt = document.createElement('option');
    opt.value = st.label;
    opt.textContent = st.label;
    opt.dataset.id = st.id;
    sel.appendChild(opt);
  });
}

/* ====== LOADER ====== */
const saveBtn = document.getElementById('saveBtn');
const btnText = saveBtn.querySelector('.btn-text');
const loaderOverlay = document.getElementById('loaderOverlay');
function setLoading(isLoading){
  loaderOverlay.setAttribute('aria-hidden', String(!isLoading));
  loaderOverlay.setAttribute('aria-busy', String(isLoading));
  saveBtn.disabled = isLoading;
  saveBtn.setAttribute('aria-busy', String(isLoading));
  if (isLoading){
    if (!saveBtn.querySelector('.btn-spinner')){
      const s = document.createElement('span');
      s.className = 'btn-spinner';
      s.setAttribute('aria-hidden', 'true');
      saveBtn.prepend(s);
    }
    btnText.textContent = 'Salvo‚Ä¶';
  }else{
    const s = saveBtn.querySelector('.btn-spinner');
    if (s) s.remove();
    btnText.textContent = 'Salva';
  }
  document.querySelectorAll('input, select, button').forEach(el => {
    if (el !== saveBtn) el.disabled = isLoading;
  });
}

/* ====== INVIO FORM ====== */
async function sendForm(data){
  const params = new URLSearchParams(data);
  const res = await fetch(ENDPOINT, {
    method:'POST',
    headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
    body: params.toString(),
  });
  return res.json();
}
async function onSaveClick(){
  const msg = document.getElementById('msg');
  msg.textContent = '';
  msg.className = '';

  const data = document.getElementById('data').value;

  // Valori normalizzati (con punto). POS: prezzo 3 dec, litri 2 dec
  const prezzoNorm = parseMoneySmart(document.getElementById('prezzo').value, 3);
  const litriNorm  = parseMoneySmart(document.getElementById('litri').value, 2);

  let importo = String(document.getElementById('importo').value).replace(',', '.');

  const stSel = document.getElementById('stazione');
  const stazione   = stSel.value;
  const stazioneId = stSel.options[stSel.selectedIndex]?.dataset?.id || '';
  const km = document.getElementById('km').value;

  if (!data){ msg.textContent='Inserisci la data.'; msg.className='err'; return; }
  if (!importo || Number(importo) <= 0){ msg.textContent='Seleziona un importo.'; msg.className='err'; return; }
  if (prezzoNorm === null || Number(prezzoNorm) <= 0){ msg.textContent='Prezzo non valido.'; msg.className='err'; return; }
  if (litriNorm === null  || Number(litriNorm)  <= 0){ msg.textContent='Litri non validi.'; msg.className='err'; return; }
  if (!stazione){ msg.textContent='Seleziona una stazione.'; msg.className='err'; return; }

  const payload = { secret: SECRET, data, importo, prezzo:prezzoNorm, litri:litriNorm, stazione, stazioneId, km };

  try{
    setLoading(true);
    const out = await sendForm(payload);
    if (out.ok){
      msg.textContent = 'Salvato ‚úÖ';
      msg.className = 'ok';
      document.getElementById('prezzo').value='';
      document.getElementById('litri').value='';
      document.getElementById('importo').selectedIndex = 0;
      document.getElementById('stazione').selectedIndex = 0;
    }else{
      msg.textContent='Errore di rete o autorizzazione.';
      msg.className='err';
    }
  }catch{
    msg.textContent='Sei offline. Dato non inviato.';
    msg.className='err';
  }finally{
    setLoading(false);
  }
}

/* ====== BOOT ====== */
document.addEventListener('DOMContentLoaded', () => {
  showAppVersion();
  initImportoOptions();
  initDate();
  initStations();

  // Attiva ‚Äústile POS‚Äù: 3 decimali per prezzo, 2 per litri
  attachPosMoney(document.getElementById('prezzo'), 3);
  attachPosMoney(document.getElementById('litri'), 2);

  document.getElementById('saveBtn').addEventListener('click', onSaveClick);
});

// ricarica se riaperta dal bfcache (come Pellet)
addEventListener('pageshow', e => e.persisted && location.reload());
</script>
</body>
</html>

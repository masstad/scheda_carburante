<!doctype html>
<html lang="it" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Carburante">
  <title>Home • Carburante</title>

  <!-- No-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <script src="js/menu.js" defer></script>
  
  <!-- Tema prima del paint (coerente col resto) -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia &&
          window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute(
          'data-theme',
          saved || (prefersDark ? 'dark' : 'light')
        );
      }catch(e){ console.warn('[Home] theme init failed:', e); }
    })();
  </script>

  <style>
    :root{
      --bg: #f6f7f9;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: rgba(15, 23, 42, 0.10);
      --shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      --accent: #2563eb;
      --accent2: #16a34a;
      --danger: #dc2626;
      --radius: 16px;
      --gap: 14px;
    }

    html[data-theme="dark"]{
      --bg: #0b1220;
      --card: #0f1b2f;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: rgba(148, 163, 184, 0.18);
      --shadow: 0 10px 30px rgba(0,0,0, 0.35);
      --accent: #60a5fa;
      --accent2: #22c55e;
      --danger: #f87171;
    }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    .wrap{
      max-width: 720px;
      margin: 0 auto;
      padding: 14px 14px 28px;
    }

    header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 2px 14px;
      position: sticky;
      top: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.0), rgba(0,0,0,0.0));
      backdrop-filter: blur(0px);
      z-index: 10;
    }

    .title{
      display:flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .title h1{
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.2px;
    }
    .title span{
      font-size: 12px;
      color: var(--muted);
      margin-top: 3px;
    }

    .iconbtn{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow);
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
    }
    .iconbtn:active{ transform: scale(0.98); }

    .stack{
      display: flex;
      flex-direction: column;
      gap: var(--gap);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .card h2{
      font-size: 14px;
      margin: 0 0 10px;
      color: var(--muted);
      font-weight: 650;
      letter-spacing: 0.2px;
    }

    /* 1) CTA Inserisci rifornimento */
    .cta-card{
      display: grid;
      place-items: center;
      padding: 18px 14px;
      text-align: center;
    }

    .plus{
      width: 64px;
      height: 64px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(37,99,235,0.14), rgba(37,99,235,0.04));
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
      transition: transform .06s ease;
    }
    .plus:active{ transform: scale(0.98); }

    .plus svg{
      width: 28px;
      height: 28px;
      fill: none;
      stroke: var(--accent);
      stroke-width: 2.6;
      stroke-linecap: round;
    }

    .cta-label{
      margin-top: 10px;
      font-weight: 750;
      letter-spacing: 0.2px;
    }
    .cta-sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    /* righe key/value */
    .kv{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: baseline;
      padding: 9px 0;
      border-top: 1px solid var(--border);
    }
    .kv:first-of-type{ border-top: none; padding-top: 0; }
    .k{ color: var(--muted); font-size: 12px; }
    .v{ font-weight: 700; }

    .pill{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
      background: rgba(0,0,0,0.02);
    }
    html[data-theme="dark"] .pill{ background: rgba(255,255,255,0.04); }

    /* 5) Navigazione rapida */
    .quick-title{
      font-size: 13px;
      margin: 18px 2px 10px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .quick{
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @media (max-width: 420px){
      .quick{ grid-template-columns: repeat(2, 1fr); }
    }
    .quick a{
      text-decoration: none;
      color: inherit;
    }
    .qbtn{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 12px 10px;
      display: grid;
      gap: 8px;
      justify-items: center;
      text-align: center;
      cursor: pointer;
      user-select: none;
      min-height: 88px;
    }
    .qbtn:active{ transform: scale(0.99); }

    .qicon{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      border: 1px solid var(--border);
      display: grid;
      place-items: center;
      background: rgba(0,0,0,0.02);
    }
    html[data-theme="dark"] .qicon{ background: rgba(255,255,255,0.04); }

    .qlabel{
      font-size: 12px;
      color: var(--muted);
      font-weight: 750;
      letter-spacing: 0.2px;
    }
    .muted{ color: var(--muted); }

    .row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .big{
      font-size: 22px;
      font-weight: 850;
      letter-spacing: 0.2px;
    }

    /* Ultimo rifornimento - Stazione */
    .v-station{
      font-weight: 500;
      font-size: 13px;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Carburante</h1>
        <span class="muted">Home</span>
      </div>

      <!-- Icona settings a destra (opzionale) -->
      <button class="iconbtn" id="btnSettings" aria-label="Impostazioni" title="Impostazioni">
        <!-- gear -->
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"></path>
          <path d="M19.4 15a7.7 7.7 0 0 0 .1-1l2-1.2-2-3.4-2.3.6a7.7 7.7 0 0 0-1.7-1L15 6.3h-6L8.7 8.8a7.7 7.7 0 0 0-1.7 1L4.7 9.2 2.7 12.6l2 1.2a7.7 7.7 0 0 0 .1 1l-2 1.2 2 3.4 2.3-.6a7.7 7.7 0 0 0 1.7 1L9 21.7h6l.3-2.5a7.7 7.7 0 0 0 1.7-1l2.3.6 2-3.4-2-1.2Z"></path>
        </svg>
      </button>
    </header>

    <main class="stack">

      <!-- 1) Card Inserisci rifornimento -->
      <section class="card cta-card">
        <div class="plus" id="btnNewRefuel" role="button" aria-label="Inserisci rifornimento" title="Inserisci rifornimento">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 5v14M5 12h14"></path>
          </svg>
        </div>
        <div class="cta-label">Inserisci rifornimento</div>
        <div class="cta-sub">Aggiungi rapidamente un nuovo pieno</div>
      </section>

      <!-- 2) Card ultimo rifornimento -->
      <section class="card" id="cardLast">
        <div class="row">
          <h2 style="margin:0">Ultimo rifornimento</h2>
          <span class="pill" id="lastDatePill">—</span>
        </div>
      
        <div class="kv">
          <div class="k">Importo</div>
          <div class="v" id="lastAmount">—</div>
        </div>
        <div class="kv">
          <div class="k">Prezzo</div>
          <div class="v" id="lastPrice">—</div>
        </div>
        <div class="kv">
          <div class="k">Litri</div>
          <div class="v" id="lastLiters">—</div>
        </div>
        <div class="kv">
          <div class="k">Km</div>
          <div class="v" id="lastKm">—</div>
        </div>
        <div class="kv">
          <div class="k">Stazione</div>
          <div class="v v-station" id="lastStation">—</div>
        </div>
      </section>

      <!-- 3) Card ultimo mese -->
      <section class="card" id="cardMonth">
        <h2>Ultimo mese</h2>

        <div class="kv">
          <div class="k">Rifornimenti</div>
          <div class="v" id="mCount">—</div>
        </div>
        <div class="kv">
          <div class="k">Litri totali</div>
          <div class="v" id="mLiters">—</div>
        </div>
        <div class="kv">
          <div class="k">Spesa totale</div>
          <div class="v" id="mSpent">—</div>
        </div>
        <div class="kv">
          <div class="k">Prezzo medio / L</div>
          <div class="v" id="mAvgPriceL">—</div>
        </div>
      </section>

      <!-- 4) Card Spesa del mese -->
      <section class="card" id="cardThisMonth">
        <div class="row" style="margin-bottom:6px;">
          <h2 style="margin:0">Spesa del mese</h2>
          <span class="pill" id="thisMonthPill">—</span>
        </div>

        <div class="big" id="thisMonthSpent">—</div>
        <div class="muted" style="margin-top:6px; font-size:12px;">
          Totale speso nel mese corrente
        </div>
      </section>

      <!-- 5) Navigazione rapida -->
      <div class="quick-title">Navigazione rapida</div>
      <section class="quick">
        <a href="#" id="navRifornimenti">
          <div class="qbtn">
            <div class="qicon">
              <!-- list -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M8 6h13M8 12h13M8 18h13"></path>
                <path d="M3 6h.01M3 12h.01M3 18h.01"></path>
              </svg>
            </div>
            <div class="qlabel">Rifornimenti</div>
          </div>
        </a>

        <a href="#" id="navImpianti">
          <div class="qbtn">
            <div class="qicon">
              <!-- map pin -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 21s7-4.4 7-11a7 7 0 0 0-14 0c0 6.6 7 11 7 11Z"></path>
                <path d="M12 10a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"></path>
              </svg>
            </div>
            <div class="qlabel">Impianti</div>
          </div>
        </a>

        <a href="#" id="navStats">
          <div class="qbtn">
            <div class="qicon">
              <!-- chart -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M4 19V5"></path>
                <path d="M4 19h16"></path>
                <path d="M8 16v-5"></path>
                <path d="M12 16v-9"></path>
                <path d="M16 16v-3"></path>
              </svg>
            </div>
            <div class="qlabel">Statistiche</div>
          </div>
        </a>

        <a href="#" id="navSettings">
          <div class="qbtn">
            <div class="qicon">
              <!-- gear -->
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"></path>
                <path d="M19.4 15a7.7 7.7 0 0 0 .1-1l2-1.2-2-3.4-2.3.6a7.7 7.7 0 0 0-1.7-1L15 6.3h-6L8.7 8.8a7.7 7.7 0 0 0-1.7 1L4.7 9.2 2.7 12.6l2 1.2a7.7 7.7 0 0 0 .1 1l-2 1.2 2 3.4 2.3-.6a7.7 7.7 0 0 0 1.7 1L9 21.7h6l.3-2.5a7.7 7.7 0 0 0 1.7-1l2.3.6 2-3.4-2-1.2Z"></path>
              </svg>
            </div>
            <div class="qlabel">Impostazioni</div>
          </div>
        </a>
      </section>

    </main>
  </div>

  <script>
  /* ====== CONFIG BACKEND (STESSO DI impianti_vicini.html) ====== */
  var ENDPOINT = 'https://script.google.com/macros/s/AKfycbzbqrHJempNcv0F9yY7FQ9wu5mZWLx1P1oSqvvTa-ztvBF167CGsQLfFokmx-yD4M3O/exec';
  var SECRET   = 'aX4P-92kLq-55T8b-7Hc0Z';

  /* ====== CONFIG PAGINE ====== */
  var PAGES = {
    newRefuel: 'scheda_carburante.html',
    listRefuel: 'lista_rifornimenti.html',
    impiantiVicini: 'impianti_vicini.html',
    impiantiPreferiti: 'impianti_preferiti.html',
    stats: 'statistiche.html',
    settings: 'settings.html'
  };
  var IMPIANTI_DEFAULT = PAGES.impiantiVicini;

  /* ====== FORMAT ====== */
  function fmtEUR(n){
    if (n === null || n === undefined || isNaN(Number(n))) return '—';
    return new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' }).format(Number(n));
  }
  function fmtNum(n, digits){
    if (digits === undefined) digits = 2;
    if (n === null || n === undefined || isNaN(Number(n))) return '—';
    return new Intl.NumberFormat('it-IT', { minimumFractionDigits: digits, maximumFractionDigits: digits }).format(Number(n));
  }

  /* ====== RENDER LAST REFUEL (NO ?. / ??) ====== */
  function renderLastRefuel(last){
    var dateEl = document.getElementById('lastDatePill');
    var aEl = document.getElementById('lastAmount');
    var pEl = document.getElementById('lastPrice');
    var lEl = document.getElementById('lastLiters');
    var kEl = document.getElementById('lastKm');
    var sEl = document.getElementById('lastStation');

    if (!last){
      if (dateEl) dateEl.textContent = '—';
      if (aEl) aEl.textContent = '—';
      if (pEl) pEl.textContent = '—';
      if (lEl) lEl.textContent = '—';
      if (kEl) kEl.textContent = '—';
      if (sEl) sEl.textContent = '—';
      return;
    }

    if (dateEl) dateEl.textContent = last.data ? last.data : '—';
    if (aEl) aEl.textContent = (last.importo !== null && last.importo !== undefined) ? fmtEUR(last.importo) : '—';
    if (pEl) pEl.textContent = (last.prezzo !== null && last.prezzo !== undefined) ? (fmtNum(last.prezzo, 3) + ' €/L') : '—';
    if (lEl) lEl.textContent = (last.litri !== null && last.litri !== undefined) ? (fmtNum(last.litri, 2) + ' L') : '—';
    if (kEl) kEl.textContent = last.km ? last.km : '—';
    if (sEl) sEl.textContent = last.stazione ? last.stazione : '—';
  }

  async function loadLastRefuel(){
    try{
      var url = ENDPOINT + '?action=last_refuel&secret=' + encodeURIComponent(SECRET);
      var resp = await fetch(url, { method:'GET', cache:'no-store' });
      var json = await resp.json();

      if (!json || !json.ok) throw new Error(json && json.error ? json.error : 'Errore API');
      if (!json.found || !json.last) return renderLastRefuel(null);

      renderLastRefuel(json.last);
    }catch(err){
      console.warn('[Home] loadLastRefuel failed:', err);
      renderLastRefuel(null);
    }
  }

  /* ====== NAV ====== */
  function bindNav(){
    var btnNew = document.getElementById('btnNewRefuel');
    if (btnNew) btnNew.addEventListener('click', function(){ location.href = PAGES.newRefuel; });

    var btnSettings = document.getElementById('btnSettings');
    if (btnSettings) btnSettings.addEventListener('click', function(){ location.href = PAGES.settings; });

    var navR = document.getElementById('navRifornimenti');
    if (navR) navR.addEventListener('click', function(e){ e.preventDefault(); location.href = PAGES.listRefuel; });

    var navI = document.getElementById('navImpianti');
    if (navI) navI.addEventListener('click', function(e){ e.preventDefault(); location.href = IMPIANTI_DEFAULT; });

    var navS = document.getElementById('navStats');
    if (navS) navS.addEventListener('click', function(e){ e.preventDefault(); location.href = PAGES.stats; });

    var navSet = document.getElementById('navSettings');
    if (navSet) navSet.addEventListener('click', function(e){ e.preventDefault(); location.href = PAGES.settings; });
  }

  /* ====== INIT ====== */
  bindNav();
  loadLastRefuel();
</script>
  
</body>
</html>







<!doctype html>
<html lang="it" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Carburante">
  <title>Impianti vicini • Carburante</title>

  <!-- No-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Tema prima del paint (come scheda_carburante.html) -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia &&
          window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute(
          'data-theme',
          saved || (prefersDark ? 'dark' : 'light')
        );
      }catch(e){}
    })();
  </script>

  <style>
    :root{
      --space:14px;

      /* Tema chiaro */
      --bg: #ffffff;
      --text: #111827;
      --muted: #666666;
      --surface: #ffffff;
      --border: #dddddd;
      --divider: #eeeeee;
      --btn-hover: #f7f7f7;
    }
    html[data-theme="dark"]{
      --bg: #0f1115;
      --text: #e5e7eb;
      --muted: #9aa0a6;
      --surface: #151922;
      --border: #2a2f3a;
      --divider: #222834;
      --btn-hover: #1b2130;
    }
    body{ color-scheme: light dark; }

    * { box-sizing: border-box; }
    html, body { width:100%; max-width:100%; overflow-x:hidden; margin:0; }
    body{
      min-height:100dvh;
      display:flex;
      flex-direction:column;
      padding: var(--space);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .container { width:100%; max-width:640px; margin:0 auto; }

    /* HEADER */
    .topbar{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      margin-bottom:18px;
      text-align:center;
    }

    .title{
      margin:0;
      font-size:22px;
      font-weight:700;
    }

    .coords{
      font-size:13px;
      color:var(--muted);
    }

    .coords span{
      font-variant-numeric: tabular-nums;
    }

    /* Lista impianti: card come scheda_carburante */
    .card-block{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      margin-top:10px;
      background: var(--surface);
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      gap:8px;
    }

    .card-gestore{
      font-weight:600;
      font-size:14px;
    }

    .badge-self{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
    }

    .card-indirizzo{
      font-size:13px;
      margin-bottom:4px;
    }

    .card-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }

    .card-prezzo{
      font-size:18px;
      font-weight:700;
      font-variant-numeric: tabular-nums;
      margin-top:2px;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    #status{
      margin-top:4px;
      margin-bottom:8px;
      text-align:center;
    }

    #results{
      margin-top:4px;
    }

    /* Footer azioni + versione (come scheda_carburante) */
    .actions-footer{
      display:flex; gap:10px; justify-content:center;
      margin-top:auto;
      padding-top:12px;
    }
    .version-footer{
      text-align:center;
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
      width:100%;
      color: var(--muted);
    }
    .badge {
      display: inline-block;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      margin-left: 8px;
      font-variant-numeric: tabular-nums;
      background: var(--surface);
    }

    .btn{
      display:inline-flex; align-items:center; gap:6px;
      padding:10px 14px;
      border:1px solid var(--border); border-radius:12px; background: var(--surface);
      text-decoration:none; color:inherit; cursor:pointer;
      font: inherit; line-height:1;
      appearance:none; -webkit-appearance:none;
    }
    .btn:hover{ background: var(--btn-hover); }
    .btn:active{ transform:translateY(1px); }
    .btn:focus-visible{ outline:2px solid #2684ff; outline-offset:2px; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="topbar container">
    <h1 class="title">⛽️ Impianti vicini</h1>
    <div class="coords">
      Latitudine: <span id="lat">—</span> • Longitudine: <span id="lon">—</span>
    </div>
  </header>

  <!-- CONTENUTO -->
  <main class="container" role="main">
    <div id="status" class="muted">In attesa della posizione GPS…</div>
    <div id="results"></div>
  </main>

  <!-- AZIONI -->
  <div class="actions-footer container">
    <a class="btn" id="backBtn" href="index.html" target="_self" aria-label="Torna indietro">← Indietro</a>
  </div>

  <!-- Versione -->
  <div class="version-footer muted">
    Versione:<span id="appVersion" class="badge"></span>
  </div>

<script>
/* ====== CONFIG BACKEND (STESSO DI scheda_carburante.html) ====== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzbqrHJempNcv0F9yY7FQ9wu5mZWLx1P1oSqvvTa-ztvBF167CGsQLfFokmx-yD4M3O/exec';
const SECRET   = 'aX4P-92kLq-55T8b-7Hc0Z';

/* ====== VERSIONE (come scheda_carburante.html) ====== */
function formatVersionFromDate(d){
  const p=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}.${p(d.getMonth()+1)}.${p(d.getDate())}-${p(d.getHours())}:${p(d.getMinutes())}`;
}
function computeAppVersion(){
  const qs = new URLSearchParams(location.search);
  const v = qs.get('v');
  if (v) return v;
  const d = new Date(document.lastModified);
  return isNaN(d)?'dev':formatVersionFromDate(d);
}
document.getElementById('appVersion').textContent = computeAppVersion();

/* ====== UTILS ====== */
function formatCoord(value){
  if (typeof value !== 'number' || !isFinite(value)) return '—';
  return value.toFixed(6);
}
function formatPrezzo(val){
  if (typeof val !== 'number' || !isFinite(val)) return '—';
  return val.toFixed(3).replace('.', ',');
}
function formatKm(km){
  if (typeof km !== 'number' || !isFinite(km)) return '';
  return km.toFixed(3).replace('.', ',') + ' km';
}
function formatIsoToLocal(iso){
  if (!iso) return '';
  const d = new Date(iso);
  if (isNaN(d)) return String(iso);
  // formato leggibile IT
  return d.toLocaleString('it-IT', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}
function eur3(n){
  if (typeof n !== 'number' || !isFinite(n)) return '—';
  return n.toFixed(3).replace('.', ',');
}

/* ====== CARICAMENTO IMPIANTI (via Apps Script -> proxy prezzi-carburante) ====== */
async function loadImpianti(lat, lon){
  const status  = document.getElementById('status');
  const results = document.getElementById('results');

  status.textContent = 'Cerco gli impianti vicini (4 km)…';
  results.innerHTML = '';

  try{
    const url = new URL(ENDPOINT);
    url.searchParams.set('action',   'impianti_vicini');
    url.searchParams.set('secret',   SECRET);
    url.searchParams.set('latitude', String(lat));
    url.searchParams.set('longitude',String(lon));
    url.searchParams.set('radius','4');
    url.searchParams.set('distance','4');
    url.searchParams.set('fuel','gasolio');
    url.searchParams.set('results','100');

    const res  = await fetch(url.toString(), { method:'GET' });
    const data = await res.json();

    console.log('[Impianti vicini] risposta endpoint:', data);

    // Se Apps Script risponde con wrapper {ok:false,...}
    if (data && data.ok === false){
      status.textContent = data.error || 'Errore dal server.';
      return;
    }

    // Se Apps Script è in fallback (health-check)
    if (data && data.ok === true && data.msg === 'Scheda_carburante API up'){
      status.textContent = 'Errore di configurazione backend (action=impianti_vicini non riconosciuta).';
      return;
    }

    // Caso normale: array di impianti (proxy diretto)
    const list = Array.isArray(data) ? data : [];

    if (list.length === 0){
      status.textContent = 'Nessun impianto trovato nel raggio di 4 km.';
      return;
    }

    status.textContent = `Trovati ${list.length} impianti nel raggio di 4 km (gasolio).`;
    results.innerHTML = '';

    list.forEach((imp, index) => {
  const card = document.createElement('section');
  card.className = 'card-block';

  const header = document.createElement('div');
  header.className = 'card-header';

  const left = document.createElement('div');
  left.className = 'card-gestore';
  const rank = (imp.ranking ?? (index + 1));
  const brand = imp.brand ? ` · ${imp.brand}` : '';
  left.textContent = `#${rank} · ${imp.nomeImpianto || imp.name || 'Impianto'}${brand}`;
  header.appendChild(left);

  const right = document.createElement('div');
  right.className = 'badge-self';
  // badge a destra: distanza
  const km = formatKm(imp.distanceKm);
  right.textContent = km || '—';
  header.appendChild(right);

  const indirizzo = document.createElement('div');
  indirizzo.className = 'card-indirizzo';
  indirizzo.textContent = imp.address || '';

  // Meta impianto (azienda / contatti / sito)
  const meta = document.createElement('div');
  meta.className = 'card-meta';

  if (imp.company){
    const s = document.createElement('span');
    s.textContent = `Società: ${imp.company}`;
    meta.appendChild(s);
  }
  if (imp.phoneNumber){
    const s = document.createElement('span');
    s.textContent = `Tel: ${imp.phoneNumber}`;
    meta.appendChild(s);
  }
  if (imp.email){
    const s = document.createElement('span');
    s.textContent = `Email: ${imp.email}`;
    meta.appendChild(s);
  }
  if (imp.website){
    const s = document.createElement('span');
    s.textContent = `Web: ${imp.website}`;
    meta.appendChild(s);
  }
  if (imp.location && imp.location.lat && imp.location.lng){
    const s = document.createElement('span');
    s.textContent = `${formatCoord(imp.location.lat)}, ${formatCoord(imp.location.lng)}`;
    meta.appendChild(s);
  }

  // Servizi (chip)
  const services = Array.isArray(imp.services) ? imp.services : [];
  let servicesRow = null;
  if (services.length){
    servicesRow = document.createElement('div');
    servicesRow.className = 'card-meta';
    services.slice(0, 8).forEach(sv => {
      const chip = document.createElement('span');
      chip.className = 'badge-self';
      chip.textContent = sv.description || sv.id || 'Servizio';
      servicesRow.appendChild(chip);
    });
  }

// Tabellina carburanti
// ====== CARBURANTI (SOLO GASOLIO SELF + ESPANDIBILE) ======
const fuels = Array.isArray(imp.fuels) ? imp.fuels : [];

// Gasolio Self visibile
const gasolioSelf = fuels.find(f =>
  String(f.name).toLowerCase() === 'gasolio' && f.isSelf === true
);

// Altri carburanti nascosti
const otherFuels = fuels.filter(f => f !== gasolioSelf);

const fuelsWrap = document.createElement('div');
fuelsWrap.style.marginTop = '10px';

// --- GASOLIO SELF (SE ESISTE) ---
if (gasolioSelf) {
  const row = document.createElement('div');
  row.style.display = 'flex';
  row.style.justifyContent = 'space-between';
  row.style.padding = '6px 0';
  row.style.borderTop = '1px solid var(--divider)';

  const left = document.createElement('div');

  const title = document.createElement('div');
  title.style.fontWeight = '600';
  title.textContent = 'Gasolio · Self';

  const dates = document.createElement('div');
  dates.className = 'muted';
  dates.textContent =
    (gasolioSelf.insertDate ? `Agg.: ${formatIsoToLocal(gasolioSelf.insertDate)}` : '') +
    (gasolioSelf.validityDate ? ` · Val.: ${formatIsoToLocal(gasolioSelf.validityDate)}` : '');

  left.appendChild(title);
  left.appendChild(dates);

  const price = document.createElement('div');
  price.className = 'card-prezzo';
  price.style.fontSize = '16px';
  price.textContent = '€ ' + eur3(Number(gasolioSelf.price));

  row.appendChild(left);
  row.appendChild(price);
  fuelsWrap.appendChild(row);
} else {
  const empty = document.createElement('div');
  empty.className = 'muted';
  empty.textContent = 'Gasolio Self non disponibile.';
  fuelsWrap.appendChild(empty);
}

// --- ALTRI CARBURANTI (ESPANDIBILI) ---
if (otherFuels.length > 0) {
  const details = document.createElement('details');
  details.style.marginTop = '6px';

  const summary = document.createElement('summary');
  summary.textContent = 'Mostra altri carburanti';
  summary.style.cursor = 'pointer';
  summary.style.fontSize = '13px';
  summary.style.color = 'var(--muted)';

  details.appendChild(summary);

  otherFuels.forEach(f => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.padding = '6px 0';
    row.style.borderTop = '1px solid var(--divider)';

    const left = document.createElement('div');
    left.textContent = `${f.name} · ${f.isSelf ? 'Self' : 'Servito'}`;

    const price = document.createElement('div');
    price.textContent = '€ ' + eur3(Number(f.price));

    row.appendChild(left);
    row.appendChild(price);
    details.appendChild(row);
  });

  fuelsWrap.appendChild(details);
}

card.appendChild(fuelsWrap);

  results.appendChild(card);
});

  }catch(err){
    console.error(err);
    status.textContent = 'Errore nel caricamento degli impianti. Sei offline o il servizio non risponde.';
  }
}

/* ====== GEOLOCALIZZAZIONE ====== */
function initGeolocation(){
  const latEl = document.getElementById('lat');
  const lonEl = document.getElementById('lon');
  const status = document.getElementById('status');

  const LS_LAT = 'impiantiVicini_lastLat';
  const LS_LON = 'impiantiVicini_lastLon';
  const LS_ACC = 'impiantiVicini_lastAcc';

  // 1) Fallback immediato: se ho una posizione valida salvata, uso quella subito (senza far "aspettare" l'utente)
  const cachedLat = Number(localStorage.getItem(LS_LAT));
  const cachedLon = Number(localStorage.getItem(LS_LON));
  const cachedAcc = Number(localStorage.getItem(LS_ACC));

  const hasCached = Number.isFinite(cachedLat) && Number.isFinite(cachedLon);

  if (hasCached) {
    latEl.textContent = formatCoord(cachedLat);
    lonEl.textContent = formatCoord(cachedLon);
    status.textContent = `Uso ultima posizione nota (±${Math.round(cachedAcc || 0)} m). Aggiorno la posizione…`;
    loadImpianti(cachedLat, cachedLon);
  } else {
    status.textContent = 'Richiedo la posizione…';
  }

  // 2) Provo a ottenere la posizione corrente dal browser.
  // Su desktop può essere stimata (IP/Wi‑Fi) e quindi anche molto imprecisa: in quel caso NON sostituisco la cache.
  if (!navigator.geolocation){
    status.textContent = hasCached
      ? (status.textContent + ' (Geolocalizzazione non disponibile: continuo con ultima posizione.)')
      : 'Geolocalizzazione non supportata dal dispositivo.';
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy; // metri

      // Aggiorna UI
      latEl.textContent = formatCoord(lat);
      lonEl.textContent = formatCoord(lon);

      // Soglia: se l'accuratezza è pessima (es. decine di km), preferisco NON sovrascrivere la cache (se esiste)
      const isGood = Number.isFinite(acc) ? acc <= 2000 : true; // 2 km

      if (!isGood && hasCached) {
        // Mantieni risultati della cache
        status.textContent = `Posizione stimata troppo imprecisa (±${Math.round(acc)} m). Mantengo l'ultima posizione valida.`;
        return;
      }

      // Salva cache e carica impianti
      localStorage.setItem(LS_LAT, String(lat));
      localStorage.setItem(LS_LON, String(lon));
      if (Number.isFinite(acc)) localStorage.setItem(LS_ACC, String(acc));

      status.textContent = `Posizione rilevata (±${Math.round(acc)} m).`;
      loadImpianti(lat, lon);
    },
    (err) => {
      console.warn('[Impianti vicini] errore geoloc:', err);

      // Se ho cache, continuo a usare quella e lo dico.
      if (hasCached) {
        status.textContent = `Geolocalizzazione non disponibile (${err.message}). Continuo con ultima posizione nota.`;
        return;
      }

      status.textContent = 'Errore nella geolocalizzazione.';
    },
    {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 600000 // 10 min: se il browser ha una posizione recente evita di sparare stime IP assurde
    }
  );
}


/* ====== BACK BTN: chiudi iframe in index.html se presente ====== */
document.getElementById('backBtn').addEventListener('click', (e) => {
  if (window.top !== window.self) {
    e.preventDefault();
    window.top.postMessage('close-lista', '*');
  }
});

/* ====== THEME SYNC (da index.html via postMessage) ====== */
(function(){
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t);
  }
  window.addEventListener('message', (ev) => {
    if (typeof ev.data === 'string' && ev.data.startsWith('theme:')) {
      const t = ev.data.split(':')[1];
      if (t === 'light' || t === 'dark') applyTheme(t);
    }
  });
})();
  
/* ====== BOOT ====== */
document.addEventListener('DOMContentLoaded', () => {
  initGeolocation();
});
</script>

</body>
</html>





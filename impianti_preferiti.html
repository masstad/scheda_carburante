<!doctype html>
<html lang="it" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Carburante">
  <title>Impianti preferiti • Carburante</title>

  <!-- No-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Tema prima del paint (come scheda_carburante.html) -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia &&
          window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute(
          'data-theme',
          saved || (prefersDark ? 'dark' : 'light')
        );
      }catch(e){}
    })();
  </script>

  <style>
    :root{
      --space:14px;

      /* Tema chiaro */
      --bg: #ffffff;
      --text: #111827;
      --muted: #666666;
      --surface: #ffffff;
      --border: #dddddd;
      --divider: #eeeeee;
      --btn-hover: #f7f7f7;
    }
    html[data-theme="dark"]{
      --bg: #0f1115;
      --text: #e5e7eb;
      --muted: #9aa0a6;
      --surface: #151922;
      --border: #2a2f3a;
      --divider: #222834;
      --btn-hover: #1b2130;
    }
    body{ color-scheme: light dark; }

    * { box-sizing: border-box; }
    html, body { width:100%; max-width:100%; overflow-x:hidden; margin:0; }
    body{
      min-height:100dvh;
      display:flex;
      flex-direction:column;
      padding: var(--space);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .container { width:100%; max-width:640px; margin:0 auto; }

    /* HEADER */
    .topbar{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      margin-bottom:18px;
      text-align:center;
    }

    .title{
      margin:0;
      font-size:22px;
      font-weight:700;
    }

    /* Lista impianti: card come scheda_carburante */
    .card-block{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      margin-top:10px;
      background: var(--surface);
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      gap:8px;
    }

    .card-gestore{
      font-weight:600;
      font-size:14px;
    }

    .badge-self{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
    }

    .card-indirizzo{
      font-size:13px;
      margin-bottom:4px;
    }

    .card-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    #status{
      margin-top:4px;
      margin-bottom:8px;
      text-align:center;
    }

    #results{
      margin-top:4px;
    }

    /* Footer azioni + versione (come scheda_carburante) */
    .actions-footer{
      display:flex; gap:10px; justify-content:center;
      margin-top:auto;
      padding-top:12px;
    }
    .version-footer{
      text-align:center;
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
      width:100%;
      color: var(--muted);
    }
    .badge {
      display: inline-block;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      margin-left: 8px;
      font-variant-numeric: tabular-nums;
      background: var(--surface);
    }

    .btn{
      display:inline-flex; align-items:center; gap:6px;
      padding:10px 14px;
      border:1px solid var(--border); border-radius:12px; background: var(--surface);
      text-decoration:none; color:inherit; cursor:pointer;
      font: inherit; line-height:1;
      appearance:none; -webkit-appearance:none;
    }
    .btn:hover{ background: var(--btn-hover); }
    .btn:active{ transform:translateY(1px); }
    .btn:focus-visible{ outline:2px solid #2684ff; outline-offset:2px; }

    /* ====== PREZZI (stile come impianti_vicini.html) ====== */
    .fuels-wrap{ margin-top:10px; }
    .fuel-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      border-top:1px solid var(--divider);
    }
    .fuel-left{ display:flex; flex-direction:column; min-width:0; }
    .fuel-name{
      font-weight:600;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .fuel-meta{
      font-size:12px;
      color: var(--muted);
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .fuel-right{ display:flex; align-items:flex-start; }
    .fuel-price{
      font-size:16px;
      font-weight:700;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="topbar container">
    <h1 class="title">⭐️ Impianti preferiti</h1>
    <div class="muted">Elenco dal foglio “Stazioni” • Filtra per città e marchio</div>
  </header>

  <!-- CONTENUTO -->
  <main class="container" role="main">

    <!-- FILTRI -->
    <div id="filters" style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; margin: 6px 0 10px;">
      <label for="cityFilter" class="muted" style="display:flex; align-items:center; gap:8px;">
        Città
        <select id="cityFilter" class="btn" style="padding:10px 12px;">
          <option value="__ALL__">Tutte</option>
        </select>
      </label>

      <button id="clearCity" class="btn" type="button" style="display:none;">✕ Reset</button>

      <label for="brandFilter" class="muted" style="display:flex; align-items:center; gap:8px;">
        Marchio
        <select id="brandFilter" class="btn" style="padding:10px 12px;">
          <option value="__ALL__">Tutti</option>
        </select>
      </label>

      <button id="clearBrand" class="btn" type="button" style="display:none;">✕ Reset</button>
    </div>

    <div id="status" class="muted" style="text-align:center; margin-top:4px; margin-bottom:8px;">Carico elenco preferiti…</div>
    <div id="results"></div>

  </main>

  <!-- AZIONI -->
  <div class="actions-footer container">
    <a class="btn" id="backBtn" href="index.html" target="_self" aria-label="Torna indietro">← Indietro</a>
  </div>

  <!-- Versione -->
  <div class="version-footer muted">
    Versione:<span id="appVersion" class="badge"></span>
  </div>

<script>
/* ====== CONFIG BACKEND (STESSO DI impianti_vicini.html) ====== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzbqrHJempNcv0F9yY7FQ9wu5mZWLx1P1oSqvvTa-ztvBF167CGsQLfFokmx-yD4M3O/exec';
const SECRET   = 'aX4P-92kLq-55T8b-7Hc0Z';

/* ====== VERSIONE (uguale allo stile esistente) ====== */
function formatVersionFromDate(d){
  const p=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}.${p(d.getMonth()+1)}.${p(d.getDate())}-${p(d.getHours())}:${p(d.getMinutes())}`;
}
function computeAppVersion(){
  const qs = new URLSearchParams(location.search);
  const v = qs.get('v');
  if (v) return v;
  const d = new Date(document.lastModified);
  return isNaN(d)?'dev':formatVersionFromDate(d);
}
document.getElementById('appVersion').textContent = computeAppVersion();

/* ====== STATE (filtri persistenti) ====== */
const LS_CITY  = 'impiantiPreferiti_city';
const LS_BRAND = 'impiantiPreferiti_brand';
let CURRENT_CITY  = localStorage.getItem(LS_CITY)  || '__ALL__';
let CURRENT_BRAND = localStorage.getItem(LS_BRAND) || '__ALL__';

let ALL_STATIONS = [];

/* ====== UTILS ====== */
function S(x){ return String(x ?? '').trim(); }
function formatIsoToLocal(iso){
  if (!iso) return '—';
  const d = new Date(iso);
  if (isNaN(d)) return String(iso);
  return d.toLocaleString('it-IT', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}
function eur3(n){
  const v = Number(n);
  if (!isFinite(v)) return '—';
  return v.toFixed(3).replace('.', ',');
}
function normalizeForSort(x){
  return S(x).toLowerCase();
}

/* ====== FILTRI ====== */
function populateSelect(selectEl, values, allLabel){
  const uniq = Array.from(new Set(values.map(S).filter(Boolean)))
    .sort((a,b)=>normalizeForSort(a).localeCompare(normalizeForSort(b),'it',{sensitivity:'base'}));
  selectEl.innerHTML =
    `<option value="__ALL__">${allLabel}</option>` +
    uniq.map(v => `<option value="${v.replaceAll('"','&quot;')}">${v}</option>`).join('');
}

function setupFilters(){
  const citySel    = document.getElementById('cityFilter');
  const brandSel   = document.getElementById('brandFilter');
  const clearCity  = document.getElementById('clearCity');
  const clearBrand = document.getElementById('clearBrand');

  populateSelect(citySel,  ALL_STATIONS.map(s => s.citta),  'Tutte');
  populateSelect(brandSel, ALL_STATIONS.map(s => s.marchio), 'Tutti');

  // ripristina stato se valido
  const cities = new Set(ALL_STATIONS.map(s => S(s.citta)).filter(Boolean));
  const brands = new Set(ALL_STATIONS.map(s => S(s.marchio)).filter(Boolean));

  if (!cities.has(CURRENT_CITY))  CURRENT_CITY  = '__ALL__';
  if (!brands.has(CURRENT_BRAND)) CURRENT_BRAND = '__ALL__';

  citySel.value  = CURRENT_CITY;
  brandSel.value = CURRENT_BRAND;

  clearCity.style.display  = (CURRENT_CITY  !== '__ALL__') ? 'inline-flex' : 'none';
  clearBrand.style.display = (CURRENT_BRAND !== '__ALL__') ? 'inline-flex' : 'none';

  citySel.onchange = () => {
    CURRENT_CITY = citySel.value;
    localStorage.setItem(LS_CITY, CURRENT_CITY);
    clearCity.style.display = (CURRENT_CITY !== '__ALL__') ? 'inline-flex' : 'none';
    render();
  };

  brandSel.onchange = () => {
    CURRENT_BRAND = brandSel.value;
    localStorage.setItem(LS_BRAND, CURRENT_BRAND);
    clearBrand.style.display = (CURRENT_BRAND !== '__ALL__') ? 'inline-flex' : 'none';
    render();
  };

  clearCity.onclick = () => {
    CURRENT_CITY = '__ALL__';
    localStorage.setItem(LS_CITY, CURRENT_CITY);
    citySel.value = '__ALL__';
    clearCity.style.display = 'none';
    render();
  };

  clearBrand.onclick = () => {
    CURRENT_BRAND = '__ALL__';
    localStorage.setItem(LS_BRAND, CURRENT_BRAND);
    brandSel.value = '__ALL__';
    clearBrand.style.display = 'none';
    render();
  };
}

function getFilteredStations(){
  return ALL_STATIONS.filter(s => {
    const okCity  = (CURRENT_CITY  === '__ALL__') || (S(s.citta)   === CURRENT_CITY);
    const okBrand = (CURRENT_BRAND === '__ALL__') || (S(s.marchio) === CURRENT_BRAND);
    return okCity && okBrand;
  });
}

/* ====== BACKEND CALLS (SOLO APPS SCRIPT: NO CORS) ====== */
async function apiGet(params){
  const url = new URL(ENDPOINT);
  url.searchParams.set('secret', SECRET);
  Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, String(v)));

  const r = await fetch(url.toString(), { method:'GET' });
  return await r.json();
}

async function loadStations(){
  const status = document.getElementById('status');
  status.textContent = 'Carico elenco preferiti…';

  const data = await apiGet({ action:'stazioni_full' });

  if (!data || data.ok === false){
    status.textContent = (data && data.error) ? data.error : 'Errore nel caricamento stazioni.';
    ALL_STATIONS = [];
    return;
  }

  ALL_STATIONS = Array.isArray(data.stations) ? data.stations : [];
  if (!ALL_STATIONS.length){
    status.textContent = 'Nessun impianto presente nel foglio "Stazioni".';
    return;
  }

  setupFilters();
  render();
}

/* ====== PREZZI: helpers (come impianti_vicini.html) ====== */
function sortFuelsInPlace(fuels){
  if (!Array.isArray(fuels)) return;
  fuels.sort((a,b)=>{
    const na = String(a?.name||'').localeCompare(String(b?.name||''), 'it', {sensitivity:'base'});
    if (na !== 0) return na;
    return (a?.isSelf === b?.isSelf) ? 0 : (a?.isSelf ? -1 : 1);
  });
}

function pickPrimaryFuel(fuels){
  if (!Array.isArray(fuels) || !fuels.length) return null;
  const primary = fuels.find(f => String(f?.name||'').trim().toLowerCase()==='gasolio' && f?.isSelf===true);
  return primary || fuels[0];
}

function renderFuelRow(f){
  const row = document.createElement('div');
  row.className = 'fuel-row';

  const leftCol = document.createElement('div');
  leftCol.className = 'fuel-left';

  const title = document.createElement('div');
  title.className = 'fuel-name';
  title.textContent = `${f?.name || 'Carburante'} · ${f?.isSelf ? 'Self' : 'Servito'}`;

  const dates = document.createElement('div');
  dates.className = 'fuel-meta';
  dates.textContent =
    (f?.insertDate ? `Agg.: ${formatIsoToLocal(f.insertDate)}` : 'Agg.: —') +
    (f?.validityDate ? ` · Val.: ${formatIsoToLocal(f.validityDate)}` : '');

  leftCol.appendChild(title);
  leftCol.appendChild(dates);

  const right = document.createElement('div');
  right.className = 'fuel-right';

  const price = document.createElement('div');
  price.className = 'fuel-price';
  price.textContent = '€ ' + eur3(Number(f?.price));

  right.appendChild(price);

  row.appendChild(leftCol);
  row.appendChild(right);
  return row;
}

/* ====== RENDER LISTA ====== */
function render(){
  const list = getFilteredStations();
  const status  = document.getElementById('status');
  const results = document.getElementById('results');

  const cityTxt  = (CURRENT_CITY  !== '__ALL__') ? ` • città: ${CURRENT_CITY}` : '';
  const brandTxt = (CURRENT_BRAND !== '__ALL__') ? ` • marchio: ${CURRENT_BRAND}` : '';
  status.textContent = `Trovati ${list.length} impianti preferiti${cityTxt}${brandTxt}.`;

  results.innerHTML = '';

  // cards (con placeholder prezzi)
  list.forEach((st, idx) => {
    const id = S(st.id);

    const card = document.createElement('section');
    card.className = 'card-block';
    card.style.cursor = 'pointer';

    card.addEventListener('click', async (ev) => {
      // evita che il tap sul bottone "Mostra altri carburanti" apra il dettaglio
      if (ev.target && ev.target.closest && ev.target.closest('button')) return;

      const id = S(st.id);

      // 1) Recupera SEMPRE il dettaglio MISE tramite proxy Apps Script (NO CORS)
      let detail = null;
      try{
        const data = await apiGet({ action:'servicearea', id });
        if (data && data.ok !== false && data.detail) {
          detail = data.detail;
        }
      }catch(e){
        // se fallisce, andiamo comunque avanti con i dati del foglio
      }

      // 2) Costruisci un oggetto IDENTICO (per chiavi) a quello usato in impianti_vicini.html,
      // così dettaglio_impianto.html funziona senza modifiche.
      const brand = S(detail?.brand) || S(st.marchio);
      // 2b) Recupera URL logo (stesso approccio atteso dal dettaglio: un URL diretto, tipicamente drive thumbnail)
      let logoUrl = null;
      if (brand) {
        try{
          const lr = await apiGet({ action:'brand_logo_url', brand });
          if (lr && lr.ok && lr.url) logoUrl = String(lr.url);
        }catch(e){}
      }

      const imp = {
        // campi principali usati dal dettaglio
        id: (detail && detail.id != null) ? detail.id : id,
        brand: brand || null,
        name: detail?.name || null,
        nomeImpianto: detail?.nomeImpianto || detail?.name || null,
        address: detail?.address || S(st.indirizzo) || null,
        company: detail?.company || null,
        phoneNumber: detail?.phoneNumber || null,
        email: detail?.email || null,
        website: detail?.website || null,
        services: Array.isArray(detail?.services) ? detail.services : [],
        fuels: Array.isArray(detail?.fuels) ? detail.fuels : [],

        // opzionali (non sempre presenti)
        location: detail?.location || null,

        // utili per allinearsi a impianti_vicini
        ranking: idx + 1,
        distanceKm: null,

        // IMPORTANTISSIMO: NON impostare logoUrl qui.
        // La pagina dettaglio usa la stessa logica di impianti_vicini.html:
        // - se imp.logoUrl esiste lo usa direttamente
        // - altrimenti risolve il logo in autonomia (cache all_logos o chiamata backend brand_logo_url)
        // Se qui mettiamo un URL diverso (es. brand_logo_img), in dettaglio cambiano le chiamate e può bloccarsi.
        logoUrl
      };

      try{ sessionStorage.setItem('impianto_dettaglio', JSON.stringify(imp)); }catch(e){}

      const qs = new URLSearchParams(location.search);
      const v = qs.get('v');
      const url = v ? `dettaglio_impianto.html?v=${encodeURIComponent(v)}` : 'dettaglio_impianto.html';
      window.location.href = url;
    });
const header = document.createElement('div');
    header.className = 'card-header';

    const gestore = document.createElement('div');
    gestore.className = 'card-gestore';
    gestore.textContent = `#${idx+1} · ${S(st.marchio) || '—'} · ${S(st.citta) || '—'}`;
    header.appendChild(gestore);

    const badge = document.createElement('div');
    badge.className = 'badge-self';
    badge.textContent = `ID ${id || '—'}`;
    header.appendChild(badge);

    const addr = document.createElement('div');
    addr.className = 'card-indirizzo';
    addr.textContent = S(st.indirizzo) || '—';

    const meta = document.createElement('div');
    meta.className = 'card-meta';
    const prov = document.createElement('span');
    prov.textContent = `Provincia: ${S(st.provincia) || '—'}`;
    meta.appendChild(prov);

    // prezzi (placeholder + container per toggle)
    const fuelsWrap = document.createElement('div');
    fuelsWrap.className = 'fuels-wrap';
    fuelsWrap.dataset.stationId = id;

    const loading = document.createElement('div');
    loading.className = 'muted';
    loading.style.marginTop = '6px';
    loading.textContent = 'Carico prezzi…';
    loading.dataset.role = 'loading';
    fuelsWrap.appendChild(loading);

    const err = document.createElement('div');
    err.className = 'muted';
    err.style.marginTop = '6px';
    err.style.display = 'none';
    err.dataset.role = 'error';
    fuelsWrap.appendChild(err);

    card.appendChild(header);
    card.appendChild(addr);
    card.appendChild(meta);
    card.appendChild(fuelsWrap);

    results.appendChild(card);
  });

  // carica prezzi per le card renderizzate
  loadPricesFor(list);
}

/* ====== PREZZI: servicearea via PROXY (Apps Script) ====== */
// limiter per non saturare l'endpoint
async function mapLimit(items, limit, fn){
  const out = new Array(items.length);
  let i = 0;
  const workers = Array.from({length: Math.min(limit, items.length)}, async () => {
    while (true){
      const idx = i++;
      if (idx >= items.length) break;
      out[idx] = await fn(items[idx], idx);
    }
  });
  await Promise.all(workers);
  return out;
}

async function loadPricesFor(stations){
  if (!Array.isArray(stations) || !stations.length) return;

  await mapLimit(stations, 6, async (st) => {
    const id = S(st.id);
    if (!id) return;

    const wrap = document.querySelector(`[data-station-id="${CSS.escape(id)}"]`);
    if (!wrap) return;

    const loadingEl = wrap.querySelector('[data-role="loading"]');
    const errEl     = wrap.querySelector('[data-role="error"]');

    try{
      const data = await apiGet({ action:'servicearea', id });
      // conserva i dettagli per la pagina di dettaglio
      st.__servicearea = data && data.detail ? data.detail : null;
      if (!data || data.ok === false){
        throw new Error((data && data.error) ? data.error : 'Proxy error');
      }

      const fuels = Array.isArray(data?.detail?.fuels) ? data.detail.fuels : [];
      sortFuelsInPlace(fuels);

      // pulisci placeholder
      if (loadingEl) loadingEl.remove();

      // se niente prezzi
      if (!fuels.length){
        errEl.style.display = 'block';
        errEl.textContent = 'Nessun prezzo disponibile per questo impianto.';
        return;
      }

      errEl.style.display = 'none';
      errEl.textContent = '';

      const primaryFuel = pickPrimaryFuel(fuels);
      const otherFuels  = fuels.filter(f => f !== primaryFuel);

      // riga principale (Gasolio Self se presente)
      wrap.appendChild(renderFuelRow(primaryFuel));

      // toggle altri carburanti
      if (otherFuels.length){
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn';
        toggleBtn.type = 'button';
        toggleBtn.style.marginTop = '8px';
        toggleBtn.style.fontSize = '12px';
        toggleBtn.textContent = 'Mostra altri carburanti';

        const hiddenBox = document.createElement('div');
        hiddenBox.style.display = 'none';
        otherFuels.forEach(f => hiddenBox.appendChild(renderFuelRow(f)));

        toggleBtn.addEventListener('click', () => {
          const open = hiddenBox.style.display === 'block';
          hiddenBox.style.display = open ? 'none' : 'block';
          toggleBtn.textContent = open ? 'Mostra altri carburanti' : 'Nascondi carburanti';
        });

        wrap.appendChild(toggleBtn);
        wrap.appendChild(hiddenBox);
      }

    }catch(e){
      if (loadingEl) loadingEl.remove();
      errEl.style.display = 'block';
      errEl.textContent = 'Errore nel recupero prezzi (proxy).';
    }
  });
}

/* ====== BACK BTN: se dentro iframe chiudi lista ====== */
document.getElementById('backBtn').addEventListener('click', (e) => {
  if (window.top !== window.self) {
    e.preventDefault();
    window.top.postMessage('close-lista', '*');
  }
});

/* ====== THEME SYNC (da index.html via postMessage) ====== */
(function(){
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t);
  }
  window.addEventListener('message', (ev) => {
    if (typeof ev.data === 'string' && ev.data.startsWith('theme:')) {
      const t = ev.data.split(':')[1];
      if (t === 'light' || t === 'dark') applyTheme(t);
    }
  });
})();

/* ====== BOOT ====== */
document.addEventListener('DOMContentLoaded', () => {
  loadStations().catch(err => {
    console.error(err);
    const status = document.getElementById('status');
    status.textContent = 'Errore nel caricamento dati.';
  });
});
</script>

</body>
</html>

<!doctype html>
<html lang="it" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Carburante">
  <title>Impianti vicini • Carburante</title>

  <!-- No-cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Tema iniziale -->
  <script>
    (function(){
      try{
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia &&
            window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute(
          'data-theme',
          saved || (prefersDark ? 'dark' : 'light')
        );
      }catch(e){}
    })();
  </script>

  <style>
    :root{
      --space:14px;
      --bg: #ffffff;
      --text: #111827;
      --muted: #666666;
      --surface: #ffffff;
      --border: #dddddd;
      --divider: #eeeeee;
      --btn-hover: #f7f7f7;
    }
    html[data-theme="dark"]{
      --bg: #0f1115;
      --text: #e5e7eb;
      --muted: #9aa0a6;
      --surface: #151922;
      --border: #2a2f3a;
      --divider: #222834;
      --btn-hover: #1b2130;
    }

    body{ color-scheme: light dark; }

    * { box-sizing: border-box; }
    html, body { width:100%; max-width:100%; overflow-x:hidden; margin:0; }
    body{
      min-height:100dvh;
      display:flex;
      flex-direction:column;
      padding: var(--space);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .container { width:100%; max-width:640px; margin:0 auto; }

    /* HEADER */
    .topbar{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      margin-bottom:18px;
      text-align:center;
    }
    .title{
      margin:0;
      font-size:22px;
      font-weight:700;
    }
    .coords{
      font-size:13px;
      color:var(--muted);
    }

    /* CARD impianto */
    .card-block{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      margin-top:10px;
      background: var(--surface);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      gap:8px;
    }
    .card-gestore{
      font-weight:600;
      font-size:14px;
    }
    .badge-self{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
    }
    .card-indirizzo{
      font-size:13px;
      margin-bottom:4px;
    }
    .card-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:12px;
      color:var(--muted);
    }
    .card-prezzo{
      font-size:18px;
      font-weight:700;
      font-variant-numeric: tabular-nums;
    }

    #status{
      margin-top:4px;
      margin-bottom:8px;
      text-align:center;
      font-size:13px;
      color:var(--muted);
    }

    /* FOOTER */
    .actions-footer{
      display:flex;
      gap:10px;
      justify-content:center;
      margin-top:auto;
      padding-top:12px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      padding:10px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      background: var(--surface);
      text-decoration:none;
      color:inherit;
      cursor:pointer;
    }
    .btn:hover{ background:var(--btn-hover); }

    .version-footer{
      text-align:center;
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
      color:var(--muted);
      font-size:12px;
    }
    .badge{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      margin-left:8px;
    }
  </style>
</head>
<body>

<header class="topbar container">
  <h1 class="title">⛽️ Impianti vicini</h1>
  <div class="coords">
    Latitudine: <span id="lat">—</span> • Longitudine: <span id="lon">—</span>
  </div>
</header>

<main class="container">
  <div id="status">In attesa della posizione GPS…</div>
  <div id="results"></div>
</main>

<div class="actions-footer container">
  <a class="btn" id="backBtn" href="index.html">← Indietro</a>
</div>

<div class="version-footer">
  Versione: <span id="appVersion" class="badge"></span>
</div>

<script>
/* ===== CONFIG BACKEND ===== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwFKEfcSLjdXSodQtDiIyhHPXskdLdOZ9PXTc0Dt5dlXIFxu8hhb80UwrSJpWqmzv-w/exec";
const SECRET   = "aX4P-92kLq-55T8b-7Hc0Z";

/* ===== VERSIONE ===== */
function formatVersionFromDate(d){
  const p=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}.${p(d.getMonth()+1)}.${p(d.getDate())}-${p(d.getHours())}:${p(d.getMinutes())}`;
}
document.getElementById("appVersion").textContent =
  formatVersionFromDate(new Date(document.lastModified));

/* ===== UTILS ===== */
const formatCoord = v => Number(v).toFixed(6);
const formatPrezzo = v => Number(v).toFixed(3).replace(".", ",");

/* ===== CARICA IMPIANTI (via Apps Script) ===== */
async function loadImpianti(lat, lon){
  const status = document.getElementById("status");
  const results = document.getElementById("results");

  status.textContent = "Cerco gli impianti vicini (3 km, gasolio)…";
  results.innerHTML = "";

  const url = new URL(ENDPOINT);
  url.searchParams.set("action", "impianti_vicini");
  url.searchParams.set("secret", SECRET);
  url.searchParams.set("latitude", lat);
  url.searchParams.set("longitude", lon);
  url.searchParams.set("distance", "3");
  url.searchParams.set("fuel", "gasolio");
  url.searchParams.set("results", "100");

  try{
    const res = await fetch(url);
    const data = await res.json();

    if (!Array.isArray(data)){
      status.textContent = "Errore dal server.";
      return;
    }
    if (data.length === 0){
      status.textContent = "Nessun impianto trovato nel raggio di 3 km.";
      return;
    }

    status.textContent = `Trovati ${data.length} impianti nel raggio di 3 km (gasolio).`;

    data.forEach((imp, index) => {
      const card = document.createElement("section");
      card.className = "card-block";

      const header = document.createElement("div");
      header.className = "card-header";

      const gestore = document.createElement("div");
      gestore.className = "card-gestore";
      gestore.textContent = `#${imp.ranking ?? index+1} · ${imp.gestore}`;

      header.appendChild(gestore);

      if (imp.self){
        const badge = document.createElement("span");
        badge.className = "badge-self";
        badge.textContent = "Self service";
        header.appendChild(badge);
      }

      const indirizzo = document.createElement("div");
      indirizzo.className = "card-indirizzo";
      indirizzo.textContent = imp.indirizzo;

      const prezzo = document.createElement("div");
      prezzo.className = "card-prezzo";
      prezzo.textContent = "€ " + formatPrezzo(imp.prezzo);

      const meta = document.createElement("div");
      meta.className = "card-meta";

      if (imp.distanza){
        const span = document.createElement("span");
        span.textContent = `Distanza: ${imp.distanza} km`;
        meta.appendChild(span);
      }

      if (imp.data){
        const span = document.createElement("span");
        span.textContent = `Agg.: ${imp.data}`;
        meta.appendChild(span);
      }

      const coord = document.createElement("span");
      coord.textContent = `(${formatCoord(imp.latitudine)}, ${formatCoord(imp.longitudine)})`;
      meta.appendChild(coord);

      card.appendChild(header);
      card.appendChild(indirizzo);
      card.appendChild(prezzo);
      card.appendChild(meta);

      results.appendChild(card);
    });

  } catch(err){
    console.error(err);
    status.textContent = "Errore nel caricamento degli impianti.";
  }
}

/* ===== GEOLOCALIZZAZIONE ===== */
function initGeolocation(){
  const latEl = document.getElementById("lat");
  const lonEl = document.getElementById("lon");
  const status = document.getElementById("status");

  if (!navigator.geolocation){
    status.textContent = "Geolocalizzazione non supportata dal dispositivo.";
    return;
  }

  status.textContent = "Richiedo la posizione al GPS…";

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      latEl.textContent = formatCoord(lat);
      lonEl.textContent = formatCoord(lon);

      loadImpianti(lat, lon);
    },
    err => {
      status.textContent = "Impossibile ottenere la posizione.";
    },
    { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
  );
}

/* ===== SYNC TEMA ===== */
window.addEventListener("message",(ev)=>{
  if (typeof ev.data === "string" && ev.data.startsWith("theme:")){
    const t = ev.data.split(":")[1];
    document.documentElement.setAttribute("data-theme", t);
  }
});

/* ===== BACK BTN ===== */
document.getElementById("backBtn").addEventListener("click", e=>{
  if (window.top !== window.self){
    e.preventDefault();
    window.top.postMessage("close-lista","*");
  }
});

/* ===== BOOT ===== */
document.addEventListener("DOMContentLoaded", initGeolocation);
</script>

</body>
</html>
